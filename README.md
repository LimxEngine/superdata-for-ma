# SuperData åè®®è§„èŒƒ v1.0

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| åè®®åç§° | SuperData Protocol |
| ç‰ˆæœ¬ | 1.0 |
| åˆ›å»ºæ—¥æœŸ | 2025 |
| ä½œè€… | Yunsio SuperStage Team |
| çŠ¶æ€ | æ­£å¼å‘å¸ƒ |

---

## 1. æ¦‚è¿°

### 1.1 åè®®ç›®çš„

SuperData åè®®æ˜¯ä¸€ä¸ªè·¨å¼•æ“ã€è·¨å¹³å°çš„å®æ—¶æ•°æ®å…±äº«åè®®ï¼Œä¸“ä¸ºèˆå°ç¯å…·æ•°æ®åŒæ­¥è®¾è®¡ã€‚è¯¥åè®®å…è®¸ä¸åŒè½¯ä»¶å¹³å°ï¼ˆUnityã€Unreal Engineã€Vectorworksã€GrandMA ç­‰ï¼‰ä¹‹é—´å®æ—¶å…±äº«ç¯å…·é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š

- ç¯å…·ä½ç½®å’Œæ—‹è½¬
- DMX åœ°å€é…ç½®ï¼ˆUniverseã€Addressã€FixtureIDï¼‰
- ç¯å…·ç±»å‹ä¿¡æ¯
- è‡ªå®šä¹‰å±æ€§

### 1.2 è®¾è®¡åŸåˆ™

1. **ç®€æ´æ€§** - ä½¿ç”¨ JSON ä½œä¸ºè´Ÿè½½æ ¼å¼ï¼Œä¾¿äºè°ƒè¯•å’Œè·¨è¯­è¨€å®ç°
2. **å¯é æ€§** - TCP ç”¨äºæ•°æ®ä¼ è¾“ï¼ŒUDP ä»…ç”¨äºæœåŠ¡å‘ç°
3. **å…¼å®¹æ€§** - ç»Ÿä¸€åæ ‡ç³»æ ‡å‡†ï¼Œå„ç«¯è‡ªè¡Œè½¬æ¢
4. **æ‰©å±•æ€§** - é¢„ç•™è‡ªå®šä¹‰å±æ€§å­—æ®µï¼Œæ”¯æŒæœªæ¥æ‰©å±•

### 1.3 æ”¯æŒå¹³å°

| å¹³å°ä»£ç  | å¹³å°åç§° | çŠ¶æ€ |
|----------|----------|------|
| 1 | Unity | âœ… å·²å®ç° |
| 2 | Unreal Engine | âœ… å·²å®ç° |
| 3 | Vectorworks | ğŸ“‹ è®¡åˆ’ä¸­ |
| 4 | GrandMA2 | âœ… å·²å®ç° |
| 255 | Custom | é¢„ç•™ |

---

## 2. ç½‘ç»œå±‚è§„èŒƒ

### 2.1 ç«¯å£å®šä¹‰

| ç”¨é€” | åè®® | ç«¯å£ | è¯´æ˜ |
|------|------|------|------|
| æœåŠ¡å‘ç° | UDP | 5965 | å¹¿æ’­/ç»„æ’­ |
| æ•°æ®ä¼ è¾“ | TCP | 5966 | å¯é ä¼ è¾“ |

### 2.2 æ•°æ®åŒ…æ ¼å¼

æ‰€æœ‰æ•°æ®åŒ…é‡‡ç”¨ç»Ÿä¸€çš„äºŒè¿›åˆ¶å¤´ + JSON è´Ÿè½½æ ¼å¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ•°æ®åŒ…ç»“æ„ (Packet)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åç§»é‡  â”‚  é•¿åº¦  â”‚  å­—æ®µå          â”‚  ç±»å‹      â”‚  è¯´æ˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  0       â”‚  4     â”‚  Magic           â”‚  char[4]   â”‚  "SPDT"  â”‚
â”‚  4       â”‚  2     â”‚  Version         â”‚  uint16    â”‚  åè®®ç‰ˆæœ¬ â”‚
â”‚  6       â”‚  2     â”‚  PacketType      â”‚  uint16    â”‚  åŒ…ç±»å‹   â”‚
â”‚  8       â”‚  4     â”‚  SequenceNumber  â”‚  uint32    â”‚  åºåˆ—å·   â”‚
â”‚  12      â”‚  8     â”‚  Timestamp       â”‚  int64     â”‚  æ—¶é—´æˆ³   â”‚
â”‚  20      â”‚  4     â”‚  PayloadLength   â”‚  uint32    â”‚  è´Ÿè½½é•¿åº¦ â”‚
â”‚  24      â”‚  N     â”‚  Payload         â”‚  byte[N]   â”‚  JSONæ•°æ® â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2.1 å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å­—èŠ‚åº | è¯´æ˜ |
|------|------|--------|------|
| Magic | char[4] | - | å›ºå®šå€¼ "SPDT" (0x53, 0x50, 0x44, 0x54) |
| Version | uint16 | Little Endian | å½“å‰ç‰ˆæœ¬: 1 |
| PacketType | uint16 | Little Endian | è§ [3. æ•°æ®åŒ…ç±»å‹](#3-æ•°æ®åŒ…ç±»å‹) |
| SequenceNumber | uint32 | Little Endian | é€’å¢åºåˆ—å·ï¼Œç”¨äºè¿½è¸ª |
| Timestamp | int64 | Little Endian | Unix æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ |
| PayloadLength | uint32 | Little Endian | JSON è´Ÿè½½çš„å­—èŠ‚é•¿åº¦ |
| Payload | byte[] | UTF-8 | JSON æ ¼å¼çš„è´Ÿè½½æ•°æ® |

#### 2.2.2 å¤´éƒ¨å¤§å°

**å›ºå®šå¤´éƒ¨å¤§å°: 24 å­—èŠ‚**

### 2.3 å­—èŠ‚åº

æ‰€æœ‰å¤šå­—èŠ‚æ•´æ•°é‡‡ç”¨ **Little Endianï¼ˆå°ç«¯åºï¼‰** ç¼–ç ã€‚

---

## 3. æ•°æ®åŒ…ç±»å‹

### 3.1 ç±»å‹å®šä¹‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®åŒ…ç±»å‹æšä¸¾                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åˆ†ç±»        â”‚  ä»£ç     â”‚  åç§°              â”‚  æ–¹å‘     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æœåŠ¡å‘ç°    â”‚  0x0001  â”‚  ServiceAnnounce   â”‚  S â†’ *   â”‚
â”‚              â”‚  0x0002  â”‚  ServiceQuery      â”‚  C â†’ *   â”‚
â”‚              â”‚  0x0003  â”‚  ServiceResponse   â”‚  S â†’ C   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¿æ¥ç®¡ç†    â”‚  0x0010  â”‚  Connect           â”‚  C â†’ S   â”‚
â”‚              â”‚  0x0011  â”‚  ConnectAck        â”‚  S â†’ C   â”‚
â”‚              â”‚  0x0012  â”‚  Disconnect        â”‚  C â†” S   â”‚
â”‚              â”‚  0x0013  â”‚  Heartbeat         â”‚  C â†” S   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•°æ®åŒæ­¥    â”‚  0x0020  â”‚  FixtureListRequestâ”‚  C â†’ S   â”‚
â”‚              â”‚  0x0021  â”‚  FixtureListResponseâ”‚ S â†’ C   â”‚
â”‚              â”‚  0x0022  â”‚  FixtureUpdate     â”‚  S â†’ C   â”‚
â”‚              â”‚  0x0023  â”‚  FixtureCreate     â”‚  C â†’ S   â”‚
â”‚              â”‚  0x0024  â”‚  FixtureDelete     â”‚  C â†” S   â”‚
â”‚              â”‚  0x0025  â”‚  FixtureSyncCompleteâ”‚ S â†’ C   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç±»å‹æ˜ å°„    â”‚  0x0030  â”‚  TypeListRequest   â”‚  C â†’ S   â”‚
â”‚              â”‚  0x0031  â”‚  TypeListResponse  â”‚  S â†’ C   â”‚
â”‚              â”‚  0x0032  â”‚  TypeMappingUpdate â”‚  C â†” S   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é”™è¯¯        â”‚  0xFF00  â”‚  Error             â”‚  S â†’ C   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å›¾ä¾‹: S = Server, C = Client, * = Broadcast
```

### 3.2 æœåŠ¡å‘ç°åŒ…

#### 3.2.1 ServiceAnnounce (0x0001)

æœåŠ¡ç«¯å®šæœŸå¹¿æ’­æ­¤åŒ…ï¼Œå®£å‘ŠæœåŠ¡å­˜åœ¨ã€‚

**å¹¿æ’­é—´éš”**: 1000ms  
**ç›®æ ‡**: UDP å¹¿æ’­åœ°å€ 255.255.255.255:5965

**Payload ç»“æ„**:
```json
{
    "serviceId": "a1b2c3d4e5f6...",
    "serviceName": "Unity SuperData Server",
    "platform": 1,
    "platformVersion": "2022.3.10f1",
    "superStageVersion": "1.0.0",
    "ipAddress": "192.168.1.100",
    "dataPort": 5966,
    "role": 0,
    "fixtureCount": 42,
    "requiresAuth": false,
    "projectName": "My Stage Project"
}
```

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| serviceId | string | âœ“ | æœåŠ¡å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆ32ä½åå…­è¿›åˆ¶ï¼‰ |
| serviceName | string | âœ“ | æœåŠ¡æ˜¾ç¤ºåç§° |
| platform | int | âœ“ | å¹³å°ä»£ç ï¼ˆè§1.3ï¼‰ |
| platformVersion | string | âœ“ | å¹³å°ç‰ˆæœ¬å· |
| superStageVersion | string | âœ“ | SuperStage æ’ä»¶ç‰ˆæœ¬ |
| ipAddress | string | âœ“ | TCP æœåŠ¡ IP åœ°å€ |
| dataPort | int | âœ“ | TCP æœåŠ¡ç«¯å£ |
| role | int | âœ“ | 0=Server, 1=Client, 2=Bidirectional |
| fixtureCount | int | âœ“ | å½“å‰ç¯å…·æ•°é‡ |
| requiresAuth | bool | âœ“ | æ˜¯å¦éœ€è¦è®¤è¯ |
| projectName | string | âœ— | é¡¹ç›®åç§° |

#### 3.2.2 ServiceQuery (0x0002)

å®¢æˆ·ç«¯å‘é€æ­¤åŒ…æŸ¥è¯¢å¯ç”¨æœåŠ¡ã€‚

**ç›®æ ‡**: UDP å¹¿æ’­åœ°å€ 255.255.255.255:5965

**Payload**: `{}`

#### 3.2.3 ServiceResponse (0x0003)

æœåŠ¡ç«¯å“åº” ServiceQueryï¼Œç»“æ„åŒ ServiceAnnounceã€‚

---

### 3.3 è¿æ¥ç®¡ç†åŒ…

#### 3.3.1 Connect (0x0010)

å®¢æˆ·ç«¯è¯·æ±‚å»ºç«‹è¿æ¥ã€‚

**Payload ç»“æ„**:
```json
{
    "clientInfo": {
        "serviceId": "...",
        "serviceName": "UE Client",
        "platform": 2,
        "platformVersion": "5.3",
        "superStageVersion": "1.0.0",
        "ipAddress": "192.168.1.101",
        "dataPort": 5966,
        "role": 1,
        "fixtureCount": 0,
        "requiresAuth": false,
        "projectName": "UE Project"
    },
    "syncMode": 0,
    "authToken": ""
}
```

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| clientInfo | ServiceInfo | å®¢æˆ·ç«¯ä¿¡æ¯ |
| syncMode | int | 0=ImportOnly, 1=ExportOnly, 2=Bidirectional |
| authToken | string | è®¤è¯ä»¤ç‰Œï¼ˆå¦‚éœ€è¦ï¼‰ |

#### 3.3.2 ConnectAck (0x0011)

æœåŠ¡ç«¯å“åº”è¿æ¥è¯·æ±‚ã€‚

**Payload ç»“æ„**:
```json
{
    "accepted": true,
    "sessionId": "session_abc123...",
    "errorCode": 0,
    "errorMessage": "",
    "serverInfo": { ... }
}
```

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| accepted | bool | æ˜¯å¦æ¥å—è¿æ¥ |
| sessionId | string | ä¼šè¯æ ‡è¯†ç¬¦ |
| errorCode | int | é”™è¯¯ä»£ç ï¼ˆè§5.1ï¼‰ |
| errorMessage | string | é”™è¯¯æè¿° |
| serverInfo | ServiceInfo | æœåŠ¡ç«¯ä¿¡æ¯ |

#### 3.3.3 Disconnect (0x0012)

ä¸»åŠ¨æ–­å¼€è¿æ¥é€šçŸ¥ã€‚

**Payload**: `{}`

#### 3.3.4 Heartbeat (0x0013)

å¿ƒè·³ä¿æ´»åŒ…ï¼ŒåŒå‘å‘é€ã€‚

**å‘é€é—´éš”**: 3000ms  
**è¶…æ—¶æ—¶é—´**: 10000msï¼ˆæœªæ”¶åˆ°å¿ƒè·³åˆ™æ–­å¼€ï¼‰

**Payload**: `{}`

---

### 3.4 æ•°æ®åŒæ­¥åŒ…

#### 3.4.1 FixtureListRequest (0x0020)

è¯·æ±‚å®Œæ•´ç¯å…·åˆ—è¡¨ã€‚

**Payload**: `{}`

#### 3.4.2 FixtureListResponse (0x0021)

è¿”å›å®Œæ•´ç¯å…·åˆ—è¡¨ã€‚

**Payload ç»“æ„**:
```json
{
    "fixtures": [
        {
            "uuid": "fixture_001",
            "name": "Spot Light 1",
            "fixtureType": "BP_SpotLight",
            "universe": 1,
            "startAddress": 1,
            "fixtureID": 1,
            "position": [0.0, 5.0, 3.0],
            "rotation": [45.0, 0.0, 0.0],
            "scale": [1.0, 1.0, 1.0],
            "channelSpan": 16,
            "customProperties": {
                "manufacturer": "Robe",
                "model": "Robin 600"
            }
        }
    ],
    "fixtureTypes": ["BP_SpotLight", "BP_WashLight"],
    "totalCount": 42
}
```

#### 3.4.3 FixtureUpdate (0x0022)

å¢é‡æ›´æ–°å•ä¸ªç¯å…·ã€‚

**Payload ç»“æ„**:
```json
{
    "uuid": "fixture_001",
    "changes": {
        "position": [1.0, 5.0, 3.0],
        "universe": 2
    }
}
```

#### 3.4.4 FixtureCreate (0x0023)

è¯·æ±‚åˆ›å»ºç¯å…·ã€‚

**Payload**: å•ä¸ª Fixture å¯¹è±¡

#### 3.4.5 FixtureDelete (0x0024)

è¯·æ±‚åˆ é™¤ç¯å…·ã€‚

**Payload ç»“æ„**:
```json
{
    "uuids": ["fixture_001", "fixture_002"]
}
```

#### 3.4.6 FixtureSyncComplete (0x0025)

åŒæ­¥å®Œæˆé€šçŸ¥ã€‚

**Payload ç»“æ„**:
```json
{
    "syncedCount": 42,
    "failedCount": 0,
    "timestamp": 1700000000000
}
```

---

### 3.5 ç±»å‹æ˜ å°„åŒ…

#### 3.5.1 TypeListRequest (0x0030)

è¯·æ±‚è¿œç«¯æ”¯æŒçš„ç¯å…·ç±»å‹åˆ—è¡¨ã€‚

**Payload**: `{}`

#### 3.5.2 TypeListResponse (0x0031)

è¿”å›æ”¯æŒçš„ç¯å…·ç±»å‹ã€‚

**Payload ç»“æ„**:
```json
{
    "types": [
        "BP_SpotLight",
        "BP_WashLight",
        "BP_BeamLight",
        "BP_LEDBar"
    ]
}
```

---

## 4. æ•°æ®ç»“æ„å®šä¹‰

### 4.1 ç¯å…·æ•°æ® (SuperDataFixture)

```json
{
    "uuid": "string",           // å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆå¿…å¡«ï¼‰
    "name": "string",           // æ˜¾ç¤ºåç§°ï¼ˆå¿…å¡«ï¼‰
    "fixtureType": "string",    // ç¯å…·ç±»å‹åï¼ˆå¿…å¡«ï¼‰
    "universe": 1,              // DMX Universe (1-256)
    "startAddress": 1,          // DMX Address (1-512)
    "fixtureID": 1,             // ç¯å…·ç¼–å· (1-65535)
    "position": [0, 0, 0],      // ä½ç½® [X, Y, Z] ç±³
    "rotation": [0, 0, 0],      // æ—‹è½¬ [X, Y, Z] åº¦
    "scale": [1, 1, 1],         // ç¼©æ”¾ [X, Y, Z]
    "channelSpan": 0,           // DMX é€šé“è·¨åº¦
    "customProperties": {}      // è‡ªå®šä¹‰å±æ€§å­—å…¸
}
```

### 4.2 æœåŠ¡ä¿¡æ¯ (SuperDataServiceInfo)

```json
{
    "serviceId": "string",      // æœåŠ¡å”¯ä¸€IDï¼ˆ32ä½hexï¼‰
    "serviceName": "string",    // æœåŠ¡åç§°
    "platform": 1,              // å¹³å°ä»£ç 
    "platformVersion": "string",// å¹³å°ç‰ˆæœ¬
    "superStageVersion": "string", // æ’ä»¶ç‰ˆæœ¬
    "ipAddress": "string",      // IPåœ°å€
    "dataPort": 5966,           // TCPç«¯å£
    "role": 0,                  // è§’è‰²ä»£ç 
    "fixtureCount": 0,          // ç¯å…·æ•°é‡
    "requiresAuth": false,      // æ˜¯å¦éœ€è¦è®¤è¯
    "projectName": "string"     // é¡¹ç›®åç§°
}
```

---

## 5. åæ ‡ç³»è§„èŒƒ

### 5.1 æ ‡å‡†åæ ‡ç³»å®šä¹‰

SuperData åè®®ä½¿ç”¨ **å³æ‰‹åæ ‡ç³»ï¼ŒZè½´å‘ä¸Š** ä½œä¸ºæ ‡å‡†åæ ‡ç³»ï¼Œä¸ MVR/GDTF è¡Œä¸šæ ‡å‡†ä¸€è‡´ã€‚

```
        Z (ä¸Š)
        â”‚
        â”‚
        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€ Y (å‰/Downstage)
       /
      /
     X (å³/Stage Right)
```

| è½´ | æ–¹å‘ | æ­£å€¼å«ä¹‰ | èˆå°æœ¯è¯­ |
|----|------|----------|----------|
| X | å³ | å‘å³ç§»åŠ¨ | Stage Right |
| Y | å‰ | å‘å‰ç§»åŠ¨ | Downstageï¼ˆé¢å‘è§‚ä¼—ï¼‰|
| Z | ä¸Š | å‘ä¸Šç§»åŠ¨ | Up |

**å•ä½**: å˜ç±³ (cm) âš ï¸ é‡è¦  
**æ—‹è½¬**: æ¬§æ‹‰è§’ï¼ˆåº¦ï¼‰ï¼ŒXYZé¡ºåº
**æ‰‹æ€§**: å³æ‰‹åæ ‡ç³»

> **ä¸ºä»€ä¹ˆä½¿ç”¨å˜ç±³ï¼Ÿ**
> - ä¸ UE å•ä½ä¸€è‡´ï¼Œå‡å°‘è½¬æ¢è¯¯å·®
> - ä¸å¤§å¤šæ•° DCC è½¯ä»¶ï¼ˆ3ds Maxã€Mayaï¼‰ä¸€è‡´
> - ç²¾åº¦æ›´é«˜ï¼Œé¿å…å°æ•°ç²¾åº¦é—®é¢˜

### 5.1.1 æ‰‹æ€§ä¸æ—‹è½¬æ–¹å‘ï¼ˆâš ï¸ å…³é”®ï¼‰

**å·¦æ‰‹ç³» vs å³æ‰‹ç³»çš„æ—‹è½¬æ–¹å‘ç›¸åï¼**

```
å³æ‰‹æ³•åˆ™ï¼ˆStandard/MA/VWï¼‰ï¼š     å·¦æ‰‹æ³•åˆ™ï¼ˆUnity/UEï¼‰ï¼š
æ‹‡æŒ‡æŒ‡å‘è½´æ­£æ–¹å‘                  æ‹‡æŒ‡æŒ‡å‘è½´æ­£æ–¹å‘
å››æŒ‡å¼¯æ›²æ–¹å‘ = æ­£æ—‹è½¬æ–¹å‘         å››æŒ‡å¼¯æ›²æ–¹å‘ = æ­£æ—‹è½¬æ–¹å‘

ä»è½´æ­£æ–¹å‘çœ‹ï¼š                    ä»è½´æ­£æ–¹å‘çœ‹ï¼š
æ­£è§’åº¦ = é€†æ—¶é’ˆ                   æ­£è§’åº¦ = é¡ºæ—¶é’ˆ
```

**ç»“è®º**ï¼šå½“ä»å·¦æ‰‹ç³»è½¬æ¢åˆ°å³æ‰‹ç³»ï¼ˆæˆ–åä¹‹ï¼‰æ—¶ï¼Œ**æ‰€æœ‰æ—‹è½¬è§’åº¦éƒ½éœ€è¦å–å**ï¼

```
å·¦æ‰‹ç³» â†’ å³æ‰‹ç³»:
  stdRot.X = -localRot.X
  stdRot.Y = -localRot.Y  (è½´é‡æ˜ å°„å)
  stdRot.Z = -localRot.Z  (è½´é‡æ˜ å°„å)
```

### 5.2 å„å¹³å°åæ ‡ç³»

> **é‡è¦åŸåˆ™**: æ¯ä¸ªå¹³å°åœ¨å‘é€æ•°æ®æ—¶å°†æœ¬åœ°åæ ‡è½¬æ¢ä¸ºæ ‡å‡†åæ ‡ç³»ï¼Œåœ¨æ¥æ”¶æ•°æ®æ—¶å°†æ ‡å‡†åæ ‡ç³»è½¬æ¢ä¸ºæœ¬åœ°åæ ‡ç³»ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿è·¨å¹³å°æ•°æ®çš„æ­£ç¡®æ€§ã€‚

| å¹³å° | åæ ‡ç³» | å•ä½ | è½´å®šä¹‰ | éœ€è¦å•ä½è½¬æ¢ |
|------|--------|------|--------|--------------|
| **Standard** | å³æ‰‹ Z-up | cm | Xå³, Yå‰, Zä¸Š | - |
| Unity | å·¦æ‰‹ Y-up | m | Xå³, Yä¸Š, Zå‰ | âœ… mâ†’cm |
| UE | å·¦æ‰‹ Z-up | cm | Xå‰, Yå³, Zä¸Š | âŒ |
| MA | å³æ‰‹ Z-up | m | Xå³, Yå‰, Zä¸Š | âœ… mâ†’cm |
| VW | å³æ‰‹ Z-up | mm | Xå³, Yå‰, Zä¸Š | âœ… mmâ†’cm |

#### 5.2.1 Unity (å·¦æ‰‹ Y-up, å•ä½: m)

```
Unity:               Standard:
    Y (ä¸Š)              Z (ä¸Š)
    â”‚                   â”‚
    â”‚                   â”‚
    â”‚                   â”‚
    â””â”€â”€â”€â”€ X (å³)        â””â”€â”€â”€â”€ Y (å‰)
   /                   /
  Z (å‰)              X (å³)
```

**å•ä½**: Unity ä½¿ç”¨ç±³ (m)ï¼Œéœ€è¦ä¸æ ‡å‡†åæ ‡ç³» cm è½¬æ¢

**è½¬æ¢å…¬å¼**:

> âš ï¸ **é‡è¦**ï¼šUnity æ˜¯å·¦æ‰‹ç³»ï¼ŒStandard æ˜¯å³æ‰‹ç³»ï¼Œ**æ‰€æœ‰æ—‹è½¬è½´éƒ½éœ€è¦å–å**ï¼

```
Unity â†’ Standard:
  // ä½ç½®è½¬æ¢ (m â†’ cm) + è½´é‡æ˜ å°„
  stdPos.X = unityPos.X * 100    // X(å³) â†’ X(å³)
  stdPos.Y = unityPos.Z * 100    // Z(å‰) â†’ Y(å‰)
  stdPos.Z = unityPos.Y * 100    // Y(ä¸Š) â†’ Z(ä¸Š)
  
  // æ—‹è½¬è½¬æ¢ï¼šè½´é‡æ˜ å°„ + æ‰‹æ€§ä¿®æ­£ï¼ˆå…¨éƒ¨å–åï¼‰
  stdRot.X = -unityRot.X         // ç»•å³è½´ï¼Œæ‰‹æ€§ç›¸å
  stdRot.Y = -unityRot.Z         // ç»•å‰è½´ï¼Œæ‰‹æ€§ç›¸å
  stdRot.Z = -unityRot.Y         // ç»•ä¸Šè½´ï¼Œæ‰‹æ€§ç›¸å

Standard â†’ Unity:
  // ä½ç½®è½¬æ¢ (cm â†’ m) + è½´é‡æ˜ å°„
  unityPos.X = stdPos.X * 0.01   // X(å³) â†’ X(å³)
  unityPos.Y = stdPos.Z * 0.01   // Z(ä¸Š) â†’ Y(ä¸Š)
  unityPos.Z = stdPos.Y * 0.01   // Y(å‰) â†’ Z(å‰)
  
  // æ—‹è½¬è½¬æ¢ï¼šè½´é‡æ˜ å°„ + æ‰‹æ€§ä¿®æ­£ï¼ˆå…¨éƒ¨å–åï¼‰
  unityRot.X = -stdRot.X         // ç»•å³è½´ï¼Œæ‰‹æ€§ç›¸å
  unityRot.Y = -stdRot.Z         // ç»•ä¸Šè½´ï¼Œæ‰‹æ€§ç›¸å
  unityRot.Z = -stdRot.Y         // ç»•å‰è½´ï¼Œæ‰‹æ€§ç›¸å
```

#### 5.2.2 Unreal Engine (å·¦æ‰‹ Z-up, å•ä½: cm)

```
UE:                  Standard:
    Z (ä¸Š)              Z (ä¸Š)
    â”‚                   â”‚
    â”‚                   â”‚
    â”‚                   â”‚
    â””â”€â”€â”€â”€ Y (å³)        â””â”€â”€â”€â”€ Y (å‰)
   /                   /
  X (å‰)              X (å³)
```

**å•ä½**: UE ä½¿ç”¨å˜ç±³ (cm)ï¼Œä¸æ ‡å‡†åæ ‡ç³»ç›¸åŒï¼Œæ— éœ€è½¬æ¢å•ä½

**è½¬æ¢å…¬å¼**:

```
UE æ¬§æ‹‰è§’å®šä¹‰ï¼ˆFRotatorï¼‰ï¼š
  Pitch (ç»•å³è½´/Yè½´æ—‹è½¬)
  Yaw   (ç»•ä¸Šè½´/Zè½´æ—‹è½¬)
  Roll  (ç»•å‰è½´/Xè½´æ—‹è½¬)

Standard æ¬§æ‹‰è§’å®šä¹‰ï¼š
  X = ç»•å³è½´æ—‹è½¬ (å¯¹åº” UE Pitch)
  Y = ç»•å‰è½´æ—‹è½¬ (å¯¹åº” UE Roll)
  Z = ç»•ä¸Šè½´æ—‹è½¬ (å¯¹åº” UE Yaw)

UE â†’ Standard:
  // ä½ç½®è½¬æ¢ï¼ˆè½´é‡æ˜ å°„ï¼Œå•ä½ç›¸åŒï¼‰
  stdPos.X = uePos.Y             // Y(å³) â†’ X(å³)
  stdPos.Y = uePos.X             // X(å‰) â†’ Y(å‰)
  stdPos.Z = uePos.Z             // Z(ä¸Š) â†’ Z(ä¸Š)
  
  // æ—‹è½¬è½¬æ¢ï¼ˆæŒ‰è½´ç‰©ç†æ„ä¹‰æ˜ å°„ + 180Â°åç§»ï¼‰
  stdRot.X = ueRot.Pitch         // ç»•å³è½´
  stdRot.Y = ueRot.Roll          // ç»•å‰è½´
  stdRot.Z = ueRot.Yaw - 180     // ç»•ä¸Šè½´ï¼Œå‡180Â°åç§»

Standard â†’ UE:
  // ä½ç½®è½¬æ¢ï¼ˆè½´é‡æ˜ å°„ï¼Œå•ä½ç›¸åŒï¼‰
  uePos.X = stdPos.Y             // Y(å‰) â†’ X(å‰)
  uePos.Y = stdPos.X             // X(å³) â†’ Y(å³)
  uePos.Z = stdPos.Z             // Z(ä¸Š) â†’ Z(ä¸Š)
  
  // æ—‹è½¬è½¬æ¢ï¼ˆæŒ‰è½´ç‰©ç†æ„ä¹‰æ˜ å°„ + 180Â°åç§»ï¼‰
  ueRot.Pitch = stdRot.X         // ç»•å³è½´
  ueRot.Roll  = stdRot.Y         // ç»•å‰è½´
  ueRot.Yaw   = stdRot.Z + 180   // ç»•ä¸Šè½´ï¼ŒåŠ 180Â°åç§»
```

> **æ³¨æ„**ï¼šYaw éœ€è¦ Â±180Â° åç§»æ˜¯å› ä¸º UE å’Œ Standard çš„"å‰æ–¹"å®šä¹‰åœ¨ç»è¿‡è½´é‡æ˜ å°„åå­˜åœ¨ 180Â° çš„æœå‘å·®å¼‚ã€‚

#### 5.2.3 GrandMA2 (å³æ‰‹ Z-up, å•ä½: m)

```
MA2:                 Standard:
    Z (ä¸Š)              Z (ä¸Š)
    â”‚                   â”‚
    â”‚                   â”‚
    â”‚                   â”‚
    â””â”€â”€â”€â”€ Y (å‰)        â””â”€â”€â”€â”€ Y (å‰)
   /                   /
  X (å³)              X (å³)
```

**å•ä½**: MA2 ä½¿ç”¨ç±³ (m)ï¼ŒStandard ä½¿ç”¨å˜ç±³ (cm)ï¼Œéœ€è¦è½¬æ¢å•ä½

**è½¬æ¢å…¬å¼**:

```
Standard â†’ MA2:
  // ä½ç½®è½¬æ¢ (cm â†’ m)
  ma2Pos.X = stdPos.X * 0.01   // X(å³) â†’ X(å³)
  ma2Pos.Y = stdPos.Y * 0.01   // Y(å‰) â†’ Y(å‰)
  ma2Pos.Z = stdPos.Z * 0.01   // Z(ä¸Š) â†’ Z(ä¸Š)
  
  // æ—‹è½¬è½¬æ¢ï¼ˆæ ¹æ®å®æµ‹ä¿®æ­£ï¼‰
  ma2Rot.X = stdRot.X          // ç»•å³è½´ï¼Œä¸å˜
  ma2Rot.Y = stdRot.Y + 180    // ç»•å‰è½´ï¼Œ+180Â°
  ma2Rot.Z = stdRot.Z + 90     // ç»•ä¸Šè½´ï¼Œ+90Â°

MA2 â†’ Standard:
  // ä½ç½®è½¬æ¢ (m â†’ cm)
  stdPos.X = ma2Pos.X * 100    // X(å³) â†’ X(å³)
  stdPos.Y = ma2Pos.Y * 100    // Y(å‰) â†’ Y(å‰)
  stdPos.Z = ma2Pos.Z * 100    // Z(ä¸Š) â†’ Z(ä¸Š)
  
  // æ—‹è½¬è½¬æ¢
  stdRot.X = ma2Rot.X          // ç»•å³è½´ï¼Œä¸å˜
  stdRot.Y = ma2Rot.Y - 180    // ç»•å‰è½´ï¼Œ-180Â°
  stdRot.Z = ma2Rot.Z - 90     // ç»•ä¸Šè½´ï¼Œ-90Â°
```

> **æ³¨æ„**ï¼šMA2 çš„æ—‹è½¬åç§»æ˜¯æ ¹æ®å®é™…æµ‹è¯•å¾—å‡ºçš„ç»éªŒå€¼ï¼Œå¯èƒ½ä¸ç¯å…·é»˜è®¤æœå‘æœ‰å…³ã€‚

### 5.3 åæ ‡è½¬æ¢çŸ©é˜µ

#### Unity â†” Standard

```
Unityâ†’Standard ä½ç½®çŸ©é˜µ:     Standardâ†’Unity ä½ç½®çŸ©é˜µ:
â”Œ 1  0  0 â”                  â”Œ 1  0  0 â”
â”‚ 0  0  1 â”‚                  â”‚ 0  0  1 â”‚
â”” 0  1  0 â”˜                  â”” 0  1  0 â”˜
```

#### UE â†” Standard

```
UEâ†’Standard ä½ç½®çŸ©é˜µ:        Standardâ†’UE ä½ç½®çŸ©é˜µ:
â”Œ 0  1  0 â”                  â”Œ 0  1  0 â”
â”‚ 1  0  0 â”‚                  â”‚ 1  0  0 â”‚
â”” 0  0  1 â”˜                  â”” 0  0  1 â”˜

ï¼ˆå•ä½ç›¸åŒï¼Œä»… Xâ†”Y äº¤æ¢ï¼‰
```

---

## 6. è¿æ¥æ¡æ‰‹æµç¨‹

### 6.1 æœåŠ¡å‘ç°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                              â”‚ Server  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                        â”‚
     â”‚  â”€â”€â”€â”€ ServiceAnnounce (UDPå¹¿æ’­) â”€â”€â”€â”€â”€â–º â”‚ (å®šæœŸå¹¿æ’­)
     â”‚                                        â”‚
     â”‚  â”€â”€â”€â”€ ServiceQuery (UDPå¹¿æ’­) â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
     â”‚                                        â”‚
     â”‚  â—„â”€â”€â”€ ServiceResponse (UDPç›´æ¥) â”€â”€â”€â”€â”€â”€ â”‚
     â”‚                                        â”‚
     â–¼                                        â–¼
```

### 6.2 TCP è¿æ¥æµç¨‹

> âš ï¸ **é‡è¦æé†’**ï¼š
> - å»ºç«‹ TCP è¿æ¥åå¿…é¡»è®¾ç½® `TCP_NODELAY = true`ï¼ˆè§ 8.5ï¼‰
> - æ¥æ”¶æ•°æ®æ—¶å¿…é¡»å¤„ç† TCP ç²˜åŒ…ï¼ˆè§ 8.4ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                              â”‚ Server  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                        â”‚
     â”‚  â•â•â•â•â•â•â• TCP Connect â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–º â”‚
     â”‚         (è®¾ç½® TCP_NODELAY=true)         â”‚
     â”‚                                        â”‚
     â”‚  â”€â”€â”€â”€ Connect (0x0010) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
     â”‚                                        â”‚
     â”‚  â—„â”€â”€â”€ ConnectAck (0x0011) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
     â”‚                                        â”‚
     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€ Heartbeat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ (æ¯3ç§’)
     â”‚                                        â”‚
     â–¼                                        â–¼
```

### 6.3 æ•°æ®åŒæ­¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                              â”‚ Server  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                        â”‚
     â”‚  â”€â”€â”€â”€ TypeListRequest (0x0030) â”€â”€â”€â”€â”€â”€â–º â”‚
     â”‚                                        â”‚
     â”‚  â—„â”€â”€â”€ TypeListResponse (0x0031) â”€â”€â”€â”€â”€â”€ â”‚
     â”‚                                        â”‚
     â”‚  [å®¢æˆ·ç«¯é…ç½®ç±»å‹æ˜ å°„]                   â”‚
     â”‚                                        â”‚
     â”‚  â”€â”€â”€â”€ FixtureListRequest (0x0020) â”€â”€â”€â–º â”‚
     â”‚                                        â”‚
     â”‚  â—„â”€â”€â”€ FixtureListResponse (0x0021) â”€â”€â”€ â”‚
     â”‚                                        â”‚
     â”‚  [å®¢æˆ·ç«¯å¤„ç†ç¯å…·æ•°æ®]                   â”‚
     â”‚                                        â”‚
     â”‚  â—„â”€â”€â”€ FixtureSyncComplete (0x0025) â”€â”€â”€ â”‚
     â”‚                                        â”‚
     â–¼                                        â–¼
```

---

## 7. é”™è¯¯å¤„ç†

### 7.1 é”™è¯¯ä»£ç 

| ä»£ç  | åç§° | è¯´æ˜ |
|------|------|------|
| 0 | None | æ— é”™è¯¯ |
| 1 | InvalidPacket | æ— æ•ˆæ•°æ®åŒ…æ ¼å¼ |
| 2 | VersionMismatch | åè®®ç‰ˆæœ¬ä¸åŒ¹é… |
| 3 | ConnectionRefused | è¿æ¥è¢«æ‹’ç» |
| 4 | Timeout | æ“ä½œè¶…æ—¶ |
| 5 | TypeMappingRequired | éœ€è¦ç±»å‹æ˜ å°„ |
| 6 | FixtureNotFound | ç¯å…·æœªæ‰¾åˆ° |
| 7 | PermissionDenied | æƒé™ä¸è¶³ |
| 255 | InternalError | å†…éƒ¨é”™è¯¯ |

### 7.2 é”™è¯¯å“åº”æ ¼å¼

```json
{
    "errorCode": 1,
    "errorMessage": "Invalid packet format",
    "details": "Magic header mismatch"
}
```

---

## 8. å®ç°æŒ‡å—

### 8.1 æœ€å°å®ç°è¦æ±‚

å®ç°ä¸€ä¸ªå…¼å®¹çš„ SuperData å®¢æˆ·ç«¯ï¼Œè‡³å°‘éœ€è¦ï¼š

1. **UDP ç›‘å¬** - ç›‘å¬ 5965 ç«¯å£æ¥æ”¶æœåŠ¡å¹¿æ’­
2. **TCP è¿æ¥** - è¿æ¥åˆ°æœåŠ¡ç«¯ 5966 ç«¯å£
3. **æ•°æ®åŒ…è§£æ** - è§£æ 24 å­—èŠ‚å¤´ + JSON è´Ÿè½½
4. **å¿ƒè·³æœºåˆ¶** - æ¯ 3 ç§’å‘é€/å“åº”å¿ƒè·³
5. **åæ ‡è½¬æ¢** - å®ç°æœ¬åœ°åæ ‡ç³»ä¸æ ‡å‡†åæ ‡ç³»è½¬æ¢
6. **TCP ç²˜åŒ…å¤„ç†** - âš ï¸ å¿…é¡»å¤„ç† TCP ç²˜åŒ…ï¼ˆè§ 8.4ï¼‰
7. **ç¦ç”¨ Nagle** - âš ï¸ å¿…é¡»è®¾ç½® TCP_NODELAYï¼ˆè§ 8.5ï¼‰

### 8.2 ä¼ªä»£ç ç¤ºä¾‹

#### 8.2.1 å‘é€æ•°æ®åŒ…

```pseudocode
function SendPacket(socket, packetType, payload):
    // æ„å»ºå¤´éƒ¨
    header = new byte[24]
    header[0:4] = "SPDT"
    header[4:6] = PROTOCOL_VERSION  // Little Endian
    header[6:8] = packetType        // Little Endian
    header[8:12] = sequenceNumber++ // Little Endian
    header[12:20] = currentTimeMs() // Little Endian
    
    payloadBytes = UTF8.Encode(payload)
    header[20:24] = payloadBytes.Length // Little Endian
    
    // å‘é€
    socket.Send(header + payloadBytes)
```

#### 8.2.2 æ¥æ”¶æ•°æ®åŒ…

```pseudocode
function ReceivePacket(socket):
    // è¯»å–å¤´éƒ¨
    header = socket.Receive(24)
    
    // éªŒè¯é­”æ•°
    if header[0:4] != "SPDT":
        return Error("Invalid magic")
    
    // è§£æå¤´éƒ¨
    version = ReadUInt16LE(header, 4)
    packetType = ReadUInt16LE(header, 6)
    sequence = ReadUInt32LE(header, 8)
    timestamp = ReadInt64LE(header, 12)
    payloadLength = ReadUInt32LE(header, 20)
    
    // è¯»å–è´Ÿè½½
    payload = socket.Receive(payloadLength)
    payloadJson = UTF8.Decode(payload)
    
    return (packetType, payloadJson)
```

### 8.3 æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] èƒ½å‘é€å’Œæ¥æ”¶ ServiceAnnounce
- [ ] èƒ½å“åº” ServiceQuery
- [ ] èƒ½å»ºç«‹ TCP è¿æ¥å¹¶å®Œæˆæ¡æ‰‹
- [ ] èƒ½æ­£ç¡®å‘é€/å“åº”å¿ƒè·³
- [ ] èƒ½è¯·æ±‚å’Œè§£æç¯å…·åˆ—è¡¨
- [ ] åæ ‡è½¬æ¢ç»“æœæ­£ç¡®
- [ ] èƒ½å¤„ç†ç½‘ç»œæ–­å¼€å¹¶é‡è¿
- [ ] TCP ç²˜åŒ…å¤„ç†æ­£ç¡®
- [ ] æ•°æ®ç«‹å³å‘é€ï¼ˆæ— å»¶è¿Ÿï¼‰

### 8.4 TCP ç²˜åŒ…å¤„ç†ï¼ˆâš ï¸ é‡è¦ï¼‰

TCP æ˜¯æµå¼åè®®ï¼Œ**å¤šä¸ªå°æ•°æ®åŒ…å¯èƒ½è¢«åˆå¹¶æˆä¸€ä¸ªå¤§åŒ…å‘é€**ã€‚è¿™æ˜¯ TCP çš„æ­£å¸¸è¡Œä¸ºï¼Œä½†å¦‚æœä¸æ­£ç¡®å¤„ç†ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚

#### 8.4.1 é—®é¢˜åœºæ™¯

å®¢æˆ·ç«¯è¿ç»­å‘é€ä¸¤ä¸ªè¯·æ±‚ï¼š
```
TypeListRequest (0x0030) + FixtureListRequest (0x0020)
```

ç”±äº TCP åˆå¹¶ï¼ŒæœåŠ¡ç«¯å¯èƒ½åœ¨ä¸€æ¬¡ `recv()` ä¸­æ”¶åˆ°ä¸¤ä¸ªè¯·æ±‚çš„æ•°æ®ã€‚å¦‚æœåªè§£æç¬¬ä¸€ä¸ªåŒ…ï¼Œç¬¬äºŒä¸ªè¯·æ±‚å°†è¢«ä¸¢å¼ƒï¼

#### 8.4.2 æ­£ç¡®å®ç°

**å¿…é¡»ä½¿ç”¨å¾ªç¯è§£æï¼Œç›´åˆ°ç¼“å†²åŒºä¸­æ²¡æœ‰å®Œæ•´æ•°æ®åŒ…**ï¼š

```pseudocode
pendingBuffer = []  // å¾…å¤„ç†ç¼“å†²åŒº

function OnDataReceived(newData):
    pendingBuffer.append(newData)
    
    // å¾ªç¯è§£ææ‰€æœ‰å®Œæ•´çš„æ•°æ®åŒ…
    while pendingBuffer.length >= HEADER_SIZE:
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å®Œæ•´çš„å¤´éƒ¨
        if pendingBuffer[0:4] != "SPDT":
            // æ— æ•ˆæ•°æ®ï¼Œå°è¯•æ‰¾åˆ°ä¸‹ä¸€ä¸ªæœ‰æ•ˆçš„ magic
            findNextMagic()
            continue
        
        payloadLength = ReadUInt32LE(pendingBuffer, 20)
        totalPacketSize = HEADER_SIZE + payloadLength
        
        // æ•°æ®ä¸å®Œæ•´ï¼Œç­‰å¾…æ›´å¤šæ•°æ®
        if pendingBuffer.length < totalPacketSize:
            break
        
        // æå–å®Œæ•´æ•°æ®åŒ…
        packetData = pendingBuffer[0:totalPacketSize]
        pendingBuffer.removeRange(0, totalPacketSize)
        
        // å¤„ç†æ•°æ®åŒ…
        ProcessPacket(packetData)
```

#### 8.4.3 å¸¸è§é”™è¯¯

âŒ **é”™è¯¯åšæ³•**ï¼šåªè§£æä¸€æ¬¡
```pseudocode
data = socket.recv()
packet = ParsePacket(data)  // åªè§£æäº†ç¬¬ä¸€ä¸ªåŒ…ï¼
HandlePacket(packet)
```

âœ… **æ­£ç¡®åšæ³•**ï¼šå¾ªç¯è§£æ
```pseudocode
data = socket.recv()
buffer.append(data)
while (packet = TryParsePacket(buffer)) != null:
    HandlePacket(packet)
```

### 8.5 ç¦ç”¨ Nagle ç®—æ³•ï¼ˆâš ï¸ é‡è¦ï¼‰

Nagle ç®—æ³•ä¼š**ç¼“å†²å°æ•°æ®åŒ…**ï¼Œç­‰å¾…æ›´å¤šæ•°æ®åå†å‘é€ï¼Œè¿™ä¼šå¯¼è‡´ä¸¥é‡çš„å»¶è¿Ÿï¼ˆå¯èƒ½é•¿è¾¾æ•°ç§’ç”šè‡³æ•°åˆ†é’Ÿï¼‰ã€‚

#### 8.5.1 å¿…é¡»è®¾ç½® TCP_NODELAY

**æ‰€æœ‰ TCP è¿æ¥å¿…é¡»ç¦ç”¨ Nagle ç®—æ³•**ï¼š

```cpp
// C/C++
int flag = 1;
setsockopt(socket, IPPROTO_TCP, TCP_NODELAY, &flag, sizeof(flag));
```

```csharp
// C#
tcpClient.NoDelay = true;
```

```python
# Python
socket.setsockopt(socket.IPPROTO_TCP, socket.TCP_NODELAY, 1)
```

```lua
-- Lua (LuaSocket)
tcp:setoption("tcp-nodelay", true)
```

#### 8.5.2 ä¸è®¾ç½® TCP_NODELAY çš„åæœ

| è®¾ç½® | å»¶è¿Ÿ | åæœ |
|------|------|------|
| âŒ æœªè®¾ç½® | 200ms - 5åˆ†é’Ÿ | å®¢æˆ·ç«¯è¿æ¥åé•¿æ—¶é—´æ”¶ä¸åˆ°æ•°æ® |
| âœ… å·²è®¾ç½® | < 10ms | æ•°æ®ç«‹å³å‘é€å’Œæ¥æ”¶ |

### 8.6 æœåŠ¡ç«¯æ•°æ®ç¼“å­˜ï¼ˆæ¨èï¼‰

ä¸ºäº†ç¡®ä¿å¿«é€Ÿå“åº”ï¼ŒæœåŠ¡ç«¯åº”è¯¥**é¢„ç¼“å­˜ç¯å…·æ•°æ®**ï¼š

```pseudocode
class Server:
    cachedFixtureListJson = ""
    
    function StartServer():
        // å¯åŠ¨æ—¶ç¼“å­˜ç¯å…·æ•°æ®
        fixtures = GatherAllFixtures()
        cachedFixtureListJson = JSON.stringify({
            fixtures: fixtures,
            fixtureTypes: GetTypes(fixtures),
            totalCount: fixtures.length
        })
    
    function HandleFixtureListRequest():
        // ç›´æ¥è¿”å›ç¼“å­˜ï¼Œæ— éœ€é‡æ–°æŸ¥è¯¢
        SendResponse(cachedFixtureListJson)
    
    function RefreshCache():
        // å½“ç¯å…·å˜åŒ–æ—¶åˆ·æ–°ç¼“å­˜
        cachedFixtureListJson = ...
```

**å¥½å¤„**ï¼š
- å“åº”é€Ÿåº¦å¿«ï¼ˆ< 1msï¼‰
- é¿å…ä¸»çº¿ç¨‹é˜»å¡
- æ”¯æŒå¤šå®¢æˆ·ç«¯å¹¶å‘è¯·æ±‚

---

## 9. å®‰å…¨è€ƒè™‘

### 9.1 å½“å‰é™åˆ¶

å½“å‰ç‰ˆæœ¬ï¼ˆv1.0ï¼‰ä¸åŒ…å«åŠ å¯†ï¼Œä»…é€‚ç”¨äºï¼š
- æœ¬åœ°ç½‘ç»œç¯å¢ƒ
- å—ä¿¡ä»»çš„å†…ç½‘ç¯å¢ƒ

### 9.2 æœªæ¥è®¡åˆ’

åç»­ç‰ˆæœ¬å¯èƒ½æ·»åŠ ï¼š
- TLS åŠ å¯†ä¼ è¾“
- ä»¤ç‰Œè®¤è¯æœºåˆ¶
- æƒé™æ§åˆ¶ç³»ç»Ÿ

---

## 10. æ•…éšœæ’é™¤

### 10.1 æœåŠ¡å‘ç°å¤±è´¥

å¦‚æœå®¢æˆ·ç«¯æ— æ³•å‘ç°æœåŠ¡ç«¯ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

#### 10.1.1 é˜²ç«å¢™è®¾ç½®

ç¡®ä¿ä»¥ä¸‹ç«¯å£åœ¨é˜²ç«å¢™ä¸­å·²å¼€æ”¾ï¼š

| ç«¯å£ | åè®® | æ–¹å‘ | ç”¨é€” |
|------|------|------|------|
| 5965 | UDP | å…¥ç«™/å‡ºç«™ | æœåŠ¡å‘ç°å¹¿æ’­ |
| 5966 | TCP | å…¥ç«™/å‡ºç«™ | æ•°æ®ä¼ è¾“ |

**Windows é˜²ç«å¢™å‘½ä»¤**:
```powershell
# ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
netsh advfirewall firewall add rule name="SuperData UDP" dir=in action=allow protocol=UDP localport=5965
netsh advfirewall firewall add rule name="SuperData TCP" dir=in action=allow protocol=TCP localport=5966
```

**macOS é˜²ç«å¢™**:
```bash
# ä¸´æ—¶å…è®¸
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /Applications/Unity/Unity.app
```

#### 10.1.2 ç½‘ç»œé…ç½®

1. **åŒä¸€å­ç½‘** - å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¿…é¡»åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘å­ç½‘å†…
2. **VLANéš”ç¦»** - ç¡®ä¿æ²¡æœ‰ VLAN éš”ç¦»é˜»æ­¢å¹¿æ’­
3. **è™šæ‹Ÿç½‘ç»œ** - VMware/VirtualBox çš„æ¡¥æ¥æ¨¡å¼å¯èƒ½éœ€è¦ç‰¹æ®Šé…ç½®

#### 10.1.3 å¹¿æ’­åœ°å€é—®é¢˜

æŸäº›ç½‘ç»œç¯å¢ƒä¸æ”¯æŒ `255.255.255.255` å¹¿æ’­ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨å­ç½‘å¹¿æ’­åœ°å€ï¼Œä¾‹å¦‚ï¼š
- ç½‘ç»œ `192.168.1.0/24` â†’ å¹¿æ’­åœ°å€ `192.168.1.255`

### 10.2 è¿æ¥å»ºç«‹å¤±è´¥

#### 10.2.1 ç«¯å£å ç”¨

æ£€æŸ¥ TCP 5966 ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š
```bash
# Windows
netstat -ano | findstr :5966

# Linux/macOS
lsof -i :5966
```

#### 10.2.2 é˜²ç—…æ¯’è½¯ä»¶

æŸäº›é˜²ç—…æ¯’è½¯ä»¶å¯èƒ½é˜»æ­¢ç½‘ç»œè¿æ¥ï¼Œå°è¯•ä¸´æ—¶ç¦ç”¨æˆ–æ·»åŠ ä¾‹å¤–ã€‚

### 10.3 æ•°æ®åŒæ­¥é—®é¢˜

#### 10.3.1 åæ ‡ä¸æ­£ç¡®

ç¡®ä¿å„ç«¯æ­£ç¡®å®ç°äº†åæ ‡ç³»è½¬æ¢ï¼š
- æ£€æŸ¥è½¬æ¢æ–¹å‘æ˜¯å¦æ­£ç¡®ï¼ˆå¯¼å…¥/å¯¼å‡ºï¼‰
- æ£€æŸ¥å•ä½æ˜¯å¦æ­£ç¡®è½¬æ¢ï¼ˆUEä½¿ç”¨å˜ç±³ï¼‰

#### 10.3.2 JSON è§£æé”™è¯¯

- ç¡®ä¿ JSON ä½¿ç”¨ UTF-8 ç¼–ç 
- æ£€æŸ¥ç‰¹æ®Šå­—ç¬¦æ˜¯å¦æ­£ç¡®è½¬ä¹‰

### 10.4 æ•°æ®æ¥æ”¶å»¶è¿Ÿï¼ˆå¸¸è§é—®é¢˜ï¼‰

#### 10.4.1 ç—‡çŠ¶

- è¿æ¥æˆåŠŸï¼Œä½†ç­‰å¾…å¾ˆé•¿æ—¶é—´ï¼ˆæ•°ç§’ç”šè‡³æ•°åˆ†é’Ÿï¼‰æ‰æ”¶åˆ°æ•°æ®
- TypeListResponse æ”¶åˆ°äº†ï¼Œä½† FixtureListResponse æ²¡æ”¶åˆ°
- æ•°æ®å¶å°”æ­£å¸¸ï¼Œå¶å°”ä¸¢å¤±

#### 10.4.2 åŸå› ä¸è§£å†³

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| æ•°æ®å»¶è¿Ÿæ•°ç§’/åˆ†é’Ÿ | æœªç¦ç”¨ Nagle ç®—æ³• | è®¾ç½® `TCP_NODELAY = true`ï¼ˆè§ 8.5ï¼‰|
| åªæ”¶åˆ°ç¬¬ä¸€ä¸ªå“åº” | æœªå¤„ç† TCP ç²˜åŒ… | å¾ªç¯è§£æç¼“å†²åŒºï¼ˆè§ 8.4ï¼‰|
| è¯·æ±‚æ— å“åº” | æœåŠ¡ç«¯ä¸»çº¿ç¨‹é˜»å¡ | ä½¿ç”¨æ•°æ®ç¼“å­˜ï¼ˆè§ 8.6ï¼‰|

#### 10.4.3 å¿«é€Ÿè¯Šæ–­

1. **æ£€æŸ¥å»¶è¿Ÿ**ï¼šå‘é€è¯·æ±‚åï¼Œè®°å½•æ”¶åˆ°å“åº”çš„æ—¶é—´
   - < 100ms â†’ æ­£å¸¸
   - > 1s â†’ å¯èƒ½æœªè®¾ç½® TCP_NODELAY

2. **æ£€æŸ¥ä¸¢åŒ…**ï¼šè¿ç»­å‘é€å¤šä¸ªè¯·æ±‚ï¼Œæ£€æŸ¥å“åº”æ•°é‡
   - è¯·æ±‚æ•° = å“åº”æ•° â†’ æ­£å¸¸
   - è¯·æ±‚æ•° > å“åº”æ•° â†’ å¯èƒ½æœªå¤„ç†ç²˜åŒ…

3. **æ£€æŸ¥æ—¥å¿—**ï¼šæœåŠ¡ç«¯åº”æ‰“å°æ¯ä¸ªæ”¶åˆ°çš„è¯·æ±‚
   - å¦‚æœåªæ‰“å°äº†éƒ¨åˆ†è¯·æ±‚ â†’ TCP ç²˜åŒ…é—®é¢˜

---

## 11. ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´ |
|------|------|------|
| 1.0 | 2025 | åˆå§‹ç‰ˆæœ¬ |
| 1.0.1 | 2025-11 | æ·»åŠ  TCP ç²˜åŒ…å¤„ç†è¯´æ˜ï¼ˆ8.4ï¼‰|
| 1.0.1 | 2025-11 | æ·»åŠ  TCP_NODELAY è¦æ±‚ï¼ˆ8.5ï¼‰|
| 1.0.1 | 2025-11 | æ·»åŠ æœåŠ¡ç«¯æ•°æ®ç¼“å­˜å»ºè®®ï¼ˆ8.6ï¼‰|
| 1.0.1 | 2025-11 | æ ‡å‡†åæ ‡ç³»å•ä½æ”¹ä¸ºå˜ç±³ï¼ˆcmï¼‰|
| 1.0.1 | 2025-11 | æ·»åŠ æ•°æ®å»¶è¿Ÿæ•…éšœæ’é™¤ï¼ˆ10.4ï¼‰|
| 1.0.2 | 2025-11 | **ä¿®æ­£æ—‹è½¬è½¬æ¢å…¬å¼**ï¼ˆæ‰‹æ€§é—®é¢˜ï¼‰|
| 1.0.2 | 2025-11 | æ·»åŠ æ‰‹æ€§ä¸æ—‹è½¬æ–¹å‘è¯´æ˜ï¼ˆ5.1.1ï¼‰|
| 1.0.3 | 2025-11 | **æ·»åŠ  GrandMA2 åæ ‡è½¬æ¢å…¬å¼**ï¼ˆ5.2.3ï¼‰|
| 1.0.3 | 2025-11 | GrandMA2 å®¢æˆ·ç«¯æ’ä»¶å®ç°å®Œæˆ |

---

## é™„å½• A: å¸¸é‡å®šä¹‰

```c
// åè®®å¸¸é‡
#define SUPERDATA_MAGIC         "SPDT"
#define SUPERDATA_VERSION       1
#define SUPERDATA_DISCOVERY_PORT 5965
#define SUPERDATA_DATA_PORT     5966
#define SUPERDATA_BROADCAST_MS  1000
#define SUPERDATA_HEARTBEAT_MS  3000
#define SUPERDATA_TIMEOUT_MS    10000
#define SUPERDATA_MAX_PACKET    65536

// å¹³å°ä»£ç 
#define PLATFORM_UNKNOWN        0
#define PLATFORM_UNITY          1
#define PLATFORM_UNREAL         2
#define PLATFORM_VECTORWORKS    3
#define PLATFORM_GRANDMA        4
#define PLATFORM_CUSTOM         255

// æ•°æ®åŒ…ç±»å‹
#define PKT_SERVICE_ANNOUNCE    0x0001
#define PKT_SERVICE_QUERY       0x0002
#define PKT_SERVICE_RESPONSE    0x0003
#define PKT_CONNECT             0x0010
#define PKT_CONNECT_ACK         0x0011
#define PKT_DISCONNECT          0x0012
#define PKT_HEARTBEAT           0x0013
#define PKT_FIXTURE_LIST_REQ    0x0020
#define PKT_FIXTURE_LIST_RESP   0x0021
#define PKT_FIXTURE_UPDATE      0x0022
#define PKT_FIXTURE_CREATE      0x0023
#define PKT_FIXTURE_DELETE      0x0024
#define PKT_FIXTURE_SYNC_DONE   0x0025
#define PKT_TYPE_LIST_REQ       0x0030
#define PKT_TYPE_LIST_RESP      0x0031
#define PKT_TYPE_MAPPING_UPDATE 0x0032
#define PKT_ERROR               0xFF00
```

---

## é™„å½• B: JSON Schema

### B.1 Fixture Schema

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "type": "object",
    "required": ["uuid", "name", "fixtureType", "universe", "startAddress", "fixtureID", "position", "rotation"],
    "properties": {
        "uuid": { "type": "string" },
        "name": { "type": "string" },
        "fixtureType": { "type": "string" },
        "universe": { "type": "integer", "minimum": 1, "maximum": 256 },
        "startAddress": { "type": "integer", "minimum": 1, "maximum": 512 },
        "fixtureID": { "type": "integer", "minimum": 1 },
        "position": { "type": "array", "items": { "type": "number" }, "minItems": 3, "maxItems": 3 },
        "rotation": { "type": "array", "items": { "type": "number" }, "minItems": 3, "maxItems": 3 },
        "scale": { "type": "array", "items": { "type": "number" }, "minItems": 3, "maxItems": 3 },
        "channelSpan": { "type": "integer" },
        "customProperties": { "type": "object" }
    }
}
```

---

**æ–‡æ¡£ç»“æŸ**

Â© 2025 Yunsio SuperStage Team. All rights reserved.

